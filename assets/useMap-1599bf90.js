import{u as b,A as G}from"./index-497eb4f1.js";import{C as L,k as O,aY as I,l as T}from"./index-a1fd9133.js";function S(i,u){return(u&&i[u])!==void 0}const B=(i={lat:39.90923,lng:116.397428},u="container")=>{const s=window.qq,E=new s.maps.LatLng(i.lat,i.lng),n=[],{name:e}=L(),m=O({lat:"39.90923",lng:"116.397428",address:"中国北京市北京市东城区西长安街1号"});let c,d;I(()=>{c=new s.maps.Map(document.getElementById(u),{zoom:8,center:E}),d=new s.maps.Marker({position:E,animation:s.maps.MarkerAnimation.DROP,map:c,draggable:!0,visible:!0}),l()});const l=()=>{n.push(s.maps.event.addListener(d,"dragstart",()=>{d.setAnimation(s.maps.MarkerAnimation.UP)})),n.push(s.maps.event.addListener(d,"dragend",a=>{d.setAnimation(s.maps.MarkerAnimation.DOWN),v(a.latLng)}))},g=a=>{c.setCenter(a.location),d.setPosition(a.location),Object.assign(m,a.location),m.address=a.address},v=a=>{const P=new s.maps.Geocoder({complete:function(y){g(y.detail)}});if(S(a,"lat")){const y=new s.maps.LatLng(a.lat,a.lng);P.getAddress(y)}else P.getLocation(a)};return b(e,()=>{typeof c.destroy=="function"&&c.destroy(),n.forEach(a=>{s.maps.event.removeListener(a)}),n.splice(0,n.length)}),{location:m,geocoderFun:v}},M={strokeColor:"#D60000",strokeOpacity:.6,fillOpacity:.1,fillColor:"#D60000",zIndex:99999},k={background:"#fff","font-size":"20px",padding:"5px 10px",border:"1px solid #009CED"},q={enableHighAccuracy:!0,timeout:1e4,position:"RB",offset:[10,20],zoomToAccuracy:!0,GeoLocationFirst:!1},Q=(i,u,s)=>{const{name:E}=L();let n;const e={map:void 0,polyEditor:void 0,mouseTool:void 0,placeSearch:void 0,polygons:[],texts:[]},m={fenceCode:"",fenceName:"",fencePath:[],id:0},c=T(!1),d=T(!1),l=O({...m}),g=()=>{var o,t;(o=e.polyEditor)==null||o.close(),(t=e.mouseTool)==null||t.close(!0)},v=()=>new Promise((o,t)=>{G.load({key:"d44819a368d76ea619971a50854f19b9",version:"2.0",plugins:["AMap.PolygonEditor","AMap.Geolocation","AMap.Driving","AMap.MouseTool","AMap.Geolocation","AMap.PlaceSearch"]}).then(p=>{n=p,e.map=new p.Map("map",{center:[116.400274,39.905812],zoom:12}),A(),w(),e.mouseTool=new n.MouseTool(e.map);const x=new n.Geolocation(q);e.map.addControl(x),x.getCurrentPosition((h,r)=>{h=="complete"||u(r)}),e.mouseTool.on("draw",({obj:h})=>{var r;s({msg:"电子围栏绘制完成！",status:"success"}),e.polyEditor=new n.PolygonEditor(e.map,h),e.polyEditor.open(),c.value=!0,(r=e.mouseTool)==null||r.close(!1)}),d.value=!0,o(n)}).catch(p=>{t(p)})}),w=()=>{D(),i.value.forEach((o,t)=>{e.texts.push(new n.Text({position:o.fencePath[0],text:o.fenceName,extData:{id:o.id},style:k})),e.polygons.push(new n.Polygon({path:o.fencePath,extData:{id:o.id},...M})),e.polygons[t].on("click",({target:p})=>{c.value||(g(),e.polyEditor=new n.PolygonEditor(e.map,p),e.polyEditor.open(),Object.assign(l,f(p)))})}),e.map.add([...e.polygons,...e.texts])},a=()=>{var o;g(),Object.assign(l,m),(o=e.mouseTool)==null||o.polygon({...M})},P=o=>{var p,x,h;const t=(p=e.polyEditor)==null?void 0:p.getTarget();e.polyEditor&&e.polyEditor.close(),console.log(o,i.value),i.value.some(r=>r.id===o)?((h=e.texts.find(r=>r.getExtData().id==l.id))==null||h.setText(l.fenceName),f(t).fencePath=t==null?void 0:t.getPath(),f(t).fenceName=l.fenceName):(t&&t.destroy(),e.polygons.push(new n.Polygon({path:t==null?void 0:t.getPath(),extData:{id:o},...M})),e.texts.push(new n.Text({position:(t==null?void 0:t.getPath())[0],text:l.fenceName,extData:{id:o},style:k})),e.polygons[e.polygons.length-1].on("click",({target:r})=>{c.value||(g(),e.polyEditor=new n.PolygonEditor(e.map,r),e.polyEditor.open(),Object.assign(l,f(r)))}),(x=e.map)==null||x.add([e.polygons[e.polygons.length-1],e.texts[e.texts.length-1]])),c.value=!1},y=o=>{var t;console.log(o,"item"),g(),(t=e.map)==null||t.setFitView([f(o.id)],!1,[60,60,60,60],16)},C=(o,t)=>{o.stopPropagation(),y(t),e.polyEditor=new n.PolygonEditor(e.map,f(t.id)),e.polyEditor.open(),Object.assign(l,t)},N=o=>{g(),e.polygons[o].destroy(),e.texts[o].remove(),i.value.splice(o,1),e.polygons.splice(o,1),e.texts.splice(o,1)},f=o=>S(o,"getExtData")?i.value.find(t=>t.id==o.getExtData().id):e.polygons.find(t=>t&&t.getExtData().id==o),z=(o,t=()=>{})=>{e.placeSearch?e.placeSearch.search(o,t):console.error("placeSearch is not undefined")},j=o=>e[o],A=()=>{e.placeSearch=new n.PlaceSearch({pageSize:5,pageIndex:1,city:"北京",citylimit:!1,map:e.map})},D=()=>{e.polygons.forEach(o=>{o.destroy()}),e.polygons=[],e.texts.forEach(o=>{o.destroy()}),e.texts=[]};return b(E,D),{isInit:d,isDraw:c,currentData:l,get:j,initMap:v,renderData:w,createDraw:a,viewPolygon:y,pushPolygon:P,editPolygon:C,removePolygon:N,findSearch:z,searchInit:A,unmounted:D}};export{B as a,Q as u};
